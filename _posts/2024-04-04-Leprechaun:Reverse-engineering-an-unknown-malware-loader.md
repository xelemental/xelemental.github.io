---
title:  "Leprechaun: Reverse-engineering an unknown malware loader"
layout: post
categories: reverse-engineering
---



## Table Of Contents


- Background.
- Metadata.
- Overview of the implant.
- Reverse Engineering the loader using IDA-Freeware-I.
- Reverse Engineering the loader using IDA-Freeware-II.
- Features of the loader.
- Limitations.
- Author's two cents.
- Resources.  



## Background

In the past month of April 2024, I have been swamped with a lot of work, well, fortunately, now in May, I have an ample amount of time to publish a few blogs, which I plan to and the first and a small one which, now am writing is about this malware loader known as `LeprechaunHvnc`. While browsing Twitter, I recently stumbled upon a tweet by a fellow malware researcher [Kseniia N](https://twitter.com/naumovax), about an [unknown loader](https://x.com/naumovax/status/1775185431237206209) which was discovered by Kseniia & another well-known researcher [Tony](https://twitter.com/t0nynot) from Positive Technology. 

So, this blog will contain my approach to reverse-engineer this malware loader and explain it from a layman's perspective.  We can get started without any further delay. 





## Metadata


SHA-256 : `1d0753beaabc660960bb5297f43eae38128647c2a23b02b2550646d58aff8797`

Sample: Available [here.](https://bazaar.abuse.ch/sample/1d0753beaabc660960bb5297f43eae38128647c2a23b02b2550646d58aff8797#)





## Overview of the implant. 

![Credits : CryptoInsane](https://github.com/xelemental/xelemental.github.io/assets/49472311/c44a6b7e-de8b-4e58-9892-7e499210d468)


As the post said, the malware loader is currently new in the wild, with very limited features of `installbot` which is responsible for installing the second-stager, `fetch-command` which is supposedly responsible for fetching commands from the threat actor for actions to perform on the target host and the `updateCommand` which is responsible for updating the tasks done and similar functionalities. The C2 for this loader was hosted at `65[.]20[.]106[.]109:80`. Well, last but not least is this loader based on an Irish mythical character. Let us move ahead to reverse-engineer this loader and find the workings.




## Reverse Engineering the loader using IDA-Freeware-I


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/31b3c9ef-5669-475b-8048-e23e8a0fdf18)


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/7674a28a-963b-4bc2-9b0a-bd5c5b6c1758)


Now, upon loading this sample in IDA-Freeware, and once the auto-analysis is finished, we land up on the `start` function, we see that it is using [`LoadLibraryW`](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryw) to load the `UrlMon.dll` which is responsible for exporting all the functions related to network-based activities. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/c3a7dcf8-abec-4ab3-85c2-4d456668352b)


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/01b08401-d923-4d07-bc20-c9d99ad9f17b)



Then, we can see that [`GetProcAddress`](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress) is being used to retrieve the address of `URLDownloadToFileW` API exported from the above DLL loaded, which is then stored in a variable known as `URLDownloadToFileW`. This API performs downloading content from the internet. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/565111ba-fe57-4688-8db9-1b442d06283f)


Next, it goes ahead and creates a Mutex named `LeprechaunHvnc` using [`CreateMutex`](https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-createmutexa?source=recommendations) API, which can be used as an IOC for the fellow malware analysts and researchers, interested in tracking this malware loader. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/8d9810b2-e558-4ae7-b676-609a1b52d31f)



![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/49e823d8-52ab-4642-a8b2-08ecafcbd568)


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/bd09490d-3bf1-43a4-a65b-1949054c14de)


Then, after creating the mutex, it goes ahead and uses [`InternetConnectW`] API to connect to the C2 server, at the location `65.20.106.109` with the target port `80`, with the value of `dwService` being `3` means it is trying to establish an HTTP connection with the C2 server.


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/45b80388-cf03-4e37-8935-61dafa92cec6)


Next, we move ahead to another function, and upon browsing, we see that it uses the `RegOpenKeyW` API to check if the subkey `Software\\LeprechaunHvnc` is present under the location `HKEY_CURRENT_USER` to check, if the implant `LeprechaunHvnc` is present in the victim's machine. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/9a184b52-63d5-43b5-9c1b-bcceb829d108)


Now, depending upon the output, it then moves to two different blocks of code, let us look into them one by one. The first one is `sub_4012A0` which is executed if the subkey is not found or in layman's terms the implant is not stored. 



