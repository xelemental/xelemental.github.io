---
title:  "Leprechaun: Reverse-engineering an unknown malware loader"
layout: post
categories: reverse-engineering
---



## Table Of Contents


- Background.
- Metadata.
- Overview of the implant.
- Reverse Engineering the loader using IDA-Freeware-I.
- Reverse Engineering the loader using IDA-Freeware-II.
- Features of the loader.
- Limitations.
- Author's two cents.
- Resources.  



## Background

In the past month of April 2024, I have been swamped with a lot of work, well, fortunately, now in May, I have an ample amount of time to publish a few blogs, which I plan to and the first and a small one which, now am writing is about this malware loader known as `LeprechaunHvnc`. While browsing Twitter, I recently stumbled upon a tweet by a fellow malware researcher [Kseniia N](https://twitter.com/naumovax), about an [unknown loader](https://x.com/naumovax/status/1775185431237206209) which was discovered by Kseniia & another well-known researcher [Tony](https://twitter.com/t0nynot) from Positive Technology. 

So, this blog will contain my approach to reverse-engineer this malware loader and explain it from a layman's perspective.  We can get started without any further delay. 





## Metadata


SHA-256 : `1d0753beaabc660960bb5297f43eae38128647c2a23b02b2550646d58aff8797`

Sample: Available [here.](https://bazaar.abuse.ch/sample/1d0753beaabc660960bb5297f43eae38128647c2a23b02b2550646d58aff8797#)





## Overview of the implant. 

![Credits : CryptoInsane](https://github.com/xelemental/xelemental.github.io/assets/49472311/c44a6b7e-de8b-4e58-9892-7e499210d468)


As the post said, the malware loader is currently new in the wild, with very limited features of `installbot` which is responsible for installing the second-stager, `fetch-command` which is supposedly responsible for fetching commands from the threat actor for actions to perform on the target host and the `updateCommand` which is responsible for updating the tasks done and similar functionalities. The C2 for this loader was hosted at `65[.]20[.]106[.]109:80`. Well, last but not least is this loader based on an Irish mythical character. Let us move ahead to reverse-engineer this loader and find the workings.




## Reverse Engineering the loader using IDA-Freeware-I


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/31b3c9ef-5669-475b-8048-e23e8a0fdf18)


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/7674a28a-963b-4bc2-9b0a-bd5c5b6c1758)


Now, upon loading this sample in IDA-Freeware, and once the auto-analysis is finished, we land up on the `start` function, we see that it is using [`LoadLibraryW`](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryw) to load the `UrlMon.dll` which is responsible for exporting all the functions related to network-based activities. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/c3a7dcf8-abec-4ab3-85c2-4d456668352b)


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/01b08401-d923-4d07-bc20-c9d99ad9f17b)



Then, we can see that [`GetProcAddress`](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress) is being used to retrieve the address of `URLDownloadToFileW` API exported from the above DLL loaded, which is then stored in a variable known as `URLDownloadToFileW`. This API performs downloading content from the internet. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/565111ba-fe57-4688-8db9-1b442d06283f)


Next, it goes ahead and creates a Mutex named `LeprechaunHvnc` using [`CreateMutex`](https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-createmutexa?source=recommendations) API, which can be used as an IOC for the fellow malware analysts and researchers, interested in tracking this malware loader. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/8d9810b2-e558-4ae7-b676-609a1b52d31f)



![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/49e823d8-52ab-4642-a8b2-08ecafcbd568)


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/bd09490d-3bf1-43a4-a65b-1949054c14de)


Then, after creating the mutex, it goes ahead and uses the `InternetConnectW` API to connect to the C2 server, at the location `65.20.106.109` with the target port `80`, with the value of `dwService` being `3` means it is trying to establish an HTTP connection with the C2 server.


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/45b80388-cf03-4e37-8935-61dafa92cec6)


Next, we move ahead to another function, and upon browsing, we see that it uses the `RegOpenKeyW` API to check if the subkey `Software\\LeprechaunHvnc` is present under the location `HKEY_CURRENT_USER` to check, if the implant `LeprechaunHvnc` is present in the victim's machine. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/9a184b52-63d5-43b5-9c1b-bcceb829d108)


Now, depending upon the output, it then moves to two different blocks of code, let us look into them one by one. The first one is `sub_4012A0` which is executed if the subkey is not found or in layman's terms the implant is not present in the target system and this function is responsible for installing the implant.


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/41e60c4c-9811-4aef-ba22-d0d6386b1a4a)


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/46583682-c159-403a-991f-9a4119131563)


Initially, this function uses `GetUserNameW` to enumerate the username of the target system. Then it uses `IsUserAnAdmin` to confirm whether the user is an admin or just a normal privileged user.


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/82fb532c-c136-4f04-9ea5-da743eef4e84)



Then, we have another unknown function which is `called` known as `sub_401680`, let us check the workings of this function.




![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/c8ac61d2-b79a-4fb9-aac3-b781325b1135)


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/85009481-d5ac-4bd4-b4a4-3f977b35c646)


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/80ed71ca-5252-4651-9f51-52ea0cb92ccb)





As we looked into the function it is quite clear that this function is responsible for enumerating the Windows Version and returns the current OS version of the target, whether it is a server or for a home user. Now, let us move ahead to the actual function from where this function was called. 



![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/8b8a6056-a8f5-4581-b2a1-0c37faade115)



Now, once the Windows version is enumerated using the previous version, we can see that the string length function is used to store the string length of string `Admin` or `User` into the variable `v6`, the string length of `windows_version` variable adding up with the previous `v6` variable is stored in another variable `v7`, and finally another variable `v8` stores the string length of the `Username` value returned from that `GetUserNameW` API along with the string length of contents in variable `v7` along with some extra space. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/9e4de86e-b406-4456-a14e-bd045f2e41a5)

![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/d3171629-453a-4cb3-b27f-d165b336c473)


Next, it uses `HttpOpenRequestW` to send a `GET` request copying the target URL inside the `v10` variable. Then, it is used to read the content from the internet and save the content of the implant. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/8ad70feb-d5ec-4377-9e3d-b0ee3c91d150)


Then, it creates a registry key under HKEY_CURRENT_USER named "Software\\LeprechaunHvnc" and sets a value named "ID" within that key.


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/c02b2fe5-8c9c-4bad-aa75-3011523e6283)


In case the value of lpString2 is "User", which we initially saw depends upon a check, the program creates a directory named `WindowsecurityUpdates` under the Documents folder of the current user's profile. It then copies the current executable file to the newly created directory and renames it to` windowsupdates.exe`. Additionally, it creates a subkey named `windowsupdates` under the HKEY_CURRENT_USER registry key. With this, we conclude the working of the function `sub_4012A0`, which had to be executed in case the implant was not installed, we move ahead to the other function `sub_4011F0` which is to be executed if the registry key `Software\\LeprechaunHvnc` was found. 


![image](https://github.com/xelemental/xelemental.github.io/assets/49472311/ebc70b90-af75-44a6-8276-73528c604d1f)

This function is very simple, it just checks if the value `ID` is present inside the registry key `Software\\LeprechaunHvnc` registry. 






